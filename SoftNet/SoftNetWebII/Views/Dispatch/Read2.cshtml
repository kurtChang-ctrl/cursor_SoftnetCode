@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
}


    <link href='~/lib/fullcalendar/main.css' rel='stylesheet' />
    <script src='~/lib/fullcalendar/main.js'></script>
    <script src='~/lib/fullcalendar/locales-all.js'></script>

    <script>

        $(document).ready(function () {
        IS_SYS_Clock = false;
        if (SYS_ClickBlock) { _fun.unBlock(); }
        SYS_ClickBlock = false;
            var calendarEl = document.getElementById('calendar');
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'zh-tw',
                navLink: true,
                editable: true,
                eventLimit: true,
                eventStartEditable: true,//允許事件的開始時間可通過拖動進行編輯
                eventDurationEditable: false,//允許通過調整大小來更改事件的持續時間
                headerToolbar: {
                    left: 'prev,next,today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay',
                },

                eventMouseEnter: function (event) {//滑鼠懸浮提示 event.event.title

                    $(".fc-daygrid-event").attr("title", '點選訂艙');
                },

                dateClick: function (info) {//滑鼠點選
                    //info.dayEl.style.backgroundColor = '#00FF99';

                ShowEventPopup(info);
                },

                eventClick: function (info) {
                alert('You clicked on event id: ' + info.event.id
                    + "\nSpecial start: " + info.event.start
                    + "\nAnd the title is: " + info.event.title);
                },

                events: function (fetchInfo, successCallback, failureCallback) {
                    var events = [];
                    $.ajax({
                        type: "POST",
                        url: "GetDiaryEvents",
                        dataType: "json",
                        data: {
                            start: fetchInfo.startStr,
                            end: fetchInfo.endStr
                        },
                        success: function (result) {
                            var jobScheduleList = result;
                            if (jobScheduleList.length > 0) {
                                $.each(jobScheduleList, function (i, data) {
                                    events.push({
                                    id: data.id,
                                    title: data.name,
                                    //url: prefix+j.url,//設定連結
                                    //content: '$.operate.add()',//內容（我自己定義的，框架沒有）
                                    //imageUrl: '/profile/' + j.imgUrl,//圖片連結（我自己定義的，框架沒有）
                                    color: 'pink',//設定顏色
                                    start: data.startDate,
                                    end: data.endDate,
                                    //start: new Date(j.startDate).format('yyyy-MM-dd'), // 解析時間
                                    //end:new Date(j.endDate).format('yyyy-MM-dd')
                                    //className: 'doing',//設定類名
                                    //backgroundColor: 'gray',//設定背景顏色
                                    });
                                })
                                //回撥渲染日曆
                                successCallback(events);
                            }
                        },
                        error: function () {
                            //出現錯誤回撥
                          
                        },
                    })
                },
            handleDatesRender: arg => {
              
                let params = {
                    start: arg.view.activeStart,
                    end: arg.view.activeEnd
                };
                this.$get('GetDiaryEvents', params)
                    .then((res) => {
                        this.calendarEvents = res;
                    });
            },
            });
            calendar.render();
        });


    function ShowEventPopup(date) {
        ClearPopupFormValues();
        $('#popupEventForm').modal('show');
        $('#eventTitle').focus();
    }

    function ClearPopupFormValues() {
        $('#eventID').val("");
        $('#eventTitle').val("");
        $('#eventDateTime').val("");
        $('#eventDuration').val("");
    }

    $('#btnPopupCancel').click(function () {
        ClearPopupFormValues();
        $('#popupEventForm').modal('hide');
    });

    $('#btnPopupSave').click(function () {
        $('#popupEventForm').modal('hide');
        var dataRow = {
            'StationNO': $('#eventStationNO').val(),
            'WO': $('#eventWO').val(),
            'STime': $('#eventSTime').val(),
            'CalendarNO': $('#eventCalendar').val()
        }
        ClearPopupFormValues();
        $.ajax({
            type: 'POST',
            url: "SaveNewEvent",
            data: dataRow,
            success: function (response) {
                if (response == 'true') {
                    //$('#calendar').fullCalendar('refetchEvents');
                    calendar.refetchEvents();
                    alert('New event saved!');
                }
                else {
                    alert('Error, could not save event!');
                }
            }
        });
    });
    </script>


    <div id='calendar'></div>


<div id="popupEventForm" class="modal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Add new event</div>
            </div>
            <div class="modal-body">
                <form id="EventForm" class="well">
                    <input type="hidden" id="eventID">
                    <label>工站編號</label>
                    <input type="text" id="eventStationNO" placeholder="Station NO"><br />
                    <label>工單編號</label>
                    <input type="text" id="eventWO"><br />
                    <label>開始時間</label>
                    <input type="text" id="eventSTime"><br />
                    <label>使用行事曆</label>
                    <input type="text" id="eventCalendar" placeholder="15"><br />
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" id="btnPopupCancel" data-dismiss="modal" class="btn btn-secondary">Cancel</button>
                <button type="button" id="btnPopupSave" data-dismiss="modal" class="btn btn-primary">Save event</button>
            </div>
        </div>
    </div>
</div>



